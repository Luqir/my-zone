---
title: Excel 表格合并探索
date: 2021-01-13
categories: 
 - Office
tags:
 - Excel
 - 宏编程
---

:::tip
工作中有时候需要对若干个 Excel 表格进行合并，又或者是对一个 Excel 表中的子工作表进行合并，这种情况下手动去复制粘贴不仅效率低下、容易出错，而且在表格数量非常庞大的情况下也是不切实际的，使用编程的方法能快速完成此类庞杂的工作。
:::

<!-- more -->

## 前言

本次使用两个工作簿进行测试，每个工作簿中的含有两个工作表，工作簿中的数据大致如下：
<div style="max-width:500px">

![](http://img.luqirong.com/20210121-%E5%AE%9E%E9%AA%8C%E8%A1%A8%E6%A0%BC.gif)

</div>

测试环境：
```
Excle: Microsoft Office 专业增强版 2016
OS: Windows 10 x64 2009 19042.685
```

## VBA宏编程

首先最容易想到的解决办法是直接使用 Excel 自带的 VBA 宏编程功能。

### 流程图

@flowstart
st=>start: 开始
e=>end: 结束

io1=>inputoutput: 获取起始行:>#获取起始行
op1=>operation: 创建汇总表:>#创建汇总表
op2=>operation: 遍历工作簿:>#遍历工作簿
op3=>operation: 遍历工作表:>#遍历工作表
sub1=>subroutine: 筛选数据:>#筛选数据
op4=>operation: 复制数据:>#复制数据
io2=>inputoutput: 输出提示:>#输出提示

st->io1->op1->op2->op3->sub1->op4->io2->e
@flowend



### 获取起始行

因为我们需要合并是是同表头的表格，也就是说只需要合并表头之下的数据行，表头手动复制即可，我们只需关注表头下的数据问题。而此处判断第几行开始为有效数据手动输入更为方便，所以采取获取输入框数据的方式。

此处采用 InputBox 方法，相较于 InputBox 函数而言， InputBox 方法可以限定输入类型，符合我们的要求。

```vb
Dim row As Integer
row = Application.InputBox("请输入数据开始行（即第几行开始复制）", "输入数字", Type:=1)'Type:=1表示限定输入类型为数字
```

### 创建汇总表

多个工作簿合并，汇总表放在哪个工作簿中都不太直观，所以单独建立一个工作簿存放汇总表比较好。

``` vb
Sub AddNew() 
Set NewBook = Workbooks.Add 
 With NewBook 
 .Title = "All Sales" 
 .Subject = "Sales" 
 .SaveAs Filename:="Allsales.xls" 
 End With 
End Sub
```

### 遍历工作簿


 
### 遍历工作表

### 筛选数据

### 复制数据

### 输出提示

先展示最基础的工作表合并代码，再在此之上进行优化：

```vb
Sub 合并工作表()
n = 2 '源表个数
nstart = 5 '每个单表数据的起始行数
k = nstart '目标表的行标
For i = 1 To n
  irow = nstart '行标
  While Sheets(i).Cells(irow + 1, 2) <> "" '以第2列数据为结束标示,确定源表的行数
    irow = irow + 1
  Wend
  Sheets(i).Rows(nstart & ":" & irow).Copy '复制源数据行
  Sheets(n + 1).Activate
  Sheets(n + 1).Cells(k, 1).Select
  ActiveSheet.Paste '粘贴数据
  k = k + irow - nstart + 1
Next i
End Sub
```

以上代码结果展示：


针对以上代码，有以下几个问题需要优化：

1. 第2行源表个数需要手动填写不合理，当工作表数量很多的时候容易出错
2. n+1
3. 小计问题
4. 
